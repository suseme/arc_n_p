# 第6章 能效性

> 能源有点像金钱：如果你有一个正余额，你可以用各种方式分配它，但根据本世纪初相信的经典定律，你不允许透支。
>
> —斯蒂芬·霍金

计算机使用的能源曾经是免费和无限的——或者至少我们是这么干的。过去，架构师很少考虑软件的能耗。但那些日子现在已经一去不复返了。随着移动设备作为大多数人的主要计算形式占据主导地位，物联网（IoT）在工业和政府中的日益普及，以及无处不在的云服务作为我们计算基础设施的支柱，能源已成为架构师不能再忽视的问题。能源不再是“免费和无限的了。移动设备的能效性影响着我们所有人。同样，云提供商越来越关注其服务器集群的能源效率。据报道，2016年，全球数据中心的能源消耗（40%）超过整个英国，约占全球能源消耗总量的3%。最近的估计显示，这一比例高达10%。相比于运行相关的能源成本，更重要的是冷却大型数据中心，让人们计算将整个数据中心置于太空的成本，其中冷却是免费的，太阳提供无限的电力。实际上，按照今天的发布价格，开始从经济看起来是有利的。值得注意的是，位于水下和北极气候中的服务器集群已经成为现实。

无论是低端还是高端，计算设备的能耗都成为我们应该考虑的问题。这意味着，作为架构师，我们现在需要在设计系统时考虑的一长串竞争质量中增加*能效性*。而且，与所有其他质量属性一样，需要考虑一些重要的权衡：能源使用与性能、可用性、可修改性或上市时间。因此，将能效性视为一流的质量属性非常重要，原因如下：

1. 架构方法对于控制*任何*重要的系统质量属性是必要的，能效性也不例外。如果在系统范围缺乏用于监控和管理能源的技术，那么开发人员只能自己发明它们。在最好的情况下，这将导致一种特殊的能源效率方法，产生一个难以维护、测量和发展的系统。在最坏的情况下，它将产生一种根本无法预测地实现所需能效目标的方法。

2. 大多数架构师和开发人员都没有意识到能效性是一个值得关注的质量属性，因此不知道如何对其进行工程和编码。更根本的是，他们缺乏对能效性要求的理解——又如何完整地收集和分析它们呢。在今天的教育课程中，能效性并没有被教授，甚至通常没有被提及作为程序员关心的问题。因此，学生毕业时可能会获得工程或计算机科学学位，但从未接触过这些问题。

3. 大多数架构师和开发人员缺乏合适的设计概念（模型、模式、策略等）来设计能效性，以及在运行时管理和监视它。但是，由于能效性是软件工程界相对较新的关注点，因此这些设计概念仍处于起步阶段，尚无籍可查。

云平台通常不必担心能耗（灾难场景除外），而这是却是移动设备和某些物联网（IoT）设备用户的日常关注点。在云环境中，纵向伸缩是核心竞争力，因此必须定期做出有关最佳资源分配的决策。对于物联网设备，它们的尺寸、外形尺寸和热量输出都限制了它们的设计空间——没有空间容纳笨重的电池。此外，未来十年将部署的物联网设备的绝对数量使其能耗成为一个问题。

在所有这些情况下，能效性必须与性能和可用性相平衡，这要求工程师有意识地对这种权衡进行论证。在云环境中，更多的资源分配（更多的服务器、更多的存储等）可以提高性能，并提高对单个设备故障的鲁棒性，但代价是能源和资本支出。在移动和物联网环境中，通常不是一种选择（尽管可以将计算负担从移动设备转移到云后端），因此权衡往往集中在能效性与性能和易用性上。最后，在所有情况下，能效性与可建造性和可修改性之间存在权衡。

## 6.1 能效性通用场景

根据这些考虑，我们现在可以确定能源效率通用场景的各个部分，如[表6.1][ch06tab01]所示。

**表6.1** 能源效率通用场景 <a name="ch06tab01"></a>

| 场景部分 | 描述                                                         | 可能的值                                                     |
| :------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| 来源     | 这指定了谁或什么请求或发起节约或管理能源的请求。             | 最终用户、经理、系统管理员、自动代理                         |
| 触发事件 | 节约能源的要求。                                             | 总使用量、最大瞬时使用量、平均使用量等。                     |
| 工件     | 这指定了要管理的内容。                                       | 特定设备、服务器、虚拟机、群集等。                           |
| 环境     | 能量通常在运行时进行管理，但根据系统特性，存在许多有趣的特殊情况。 | 运行时、已连接、电池供电、低电池模式、省电模式               |
| 响应     | 系统采取哪些措施来节约或管理能源使用。                       | 以下一项或多项：<br/><li>禁用服务<br/><li>解除分配的运行时服务<br/><li>更改服务器的服务分配<br/><li>以低功耗模式运行服务<br/><li>分配/解除分配服务器<br/><li>更改服务级别<br/><li>更改调度 |
| 应对措施 | 这些措施围绕节省或消耗的能源量以及对其他功能或质量属性的影响展开。 | 在以下方面管理或节省能源：<br/><br/><li>系统上的最大/平均千瓦负载<br/><li>平均/总节能量<br/><li>使用的总千瓦时<br/><li>系统必须保持通电状态的时间段<br/><br/>. . . 同时仍保持所需的功能级别和其他质量属性的可接受级别 |

[图6.1][ch06fig01] 说明了一个具体的能源效率方案： *经理希望在运行时通过在非高峰时段释放未使用的资源来节省能源。系统在解除分配资源的同时，在数据库查询上保持 2 秒的最坏情况下延迟，平均节省所需总能源的 50%*。

![A sample energy efficiency scenario is displayed.](ch06.assets/06fig01.jpg)

**图6.1** 简单的能效场景 <a name="ch06fig01"></a>

## 6.2 能效性策略 <a name="ch06sec02"></a>

能源效率方案是由节约或管理能源的愿望催化的，同时仍然提供所需的（尽管不一定是完整的）功能。如果在可接受的时间、成本和质量限制内实现能量响应，则此方案是成功的。我们在[图6.2][ch06fig02]中说明了这种简单的关系，因此也是能源效率策略的目标。

![The tactics to control response diagram is presented. The stimulus is the energy savings objective. The response is the energy responses realized within constraints.](ch06.assets/06fig02.jpg)

**图6.2** 能效策略的目标 <a name="ch06fig02"></a>

能效的核心是有效利用资源。我们将策略分为三大类：资源监控、资源分配和资源适配（[图6.3][ch06fig03]）。我们所说的“资源”是指在提供其功能的同时消耗能源的计算设备。这类似于 [第9章][ch09] 中对 *硬件* 资源的定义，其中包括 CPU、数据存储、网络通信和内存。

![A flowchart of the energy efficiency tactics.](ch06.assets/06fig03.jpg)

**图6.3** 能效策略 <a name="ch06fig03"></a>

### 监控资源

你无法管理没法衡量的内容，因此我们从资源监控开始。资源监控的策略包括：计量、静态分类和动态分类。

- *计量*。计量策略涉及通过传感器基础设施近乎实时地收集有关计算资源能耗的数据。在最粗略的层面上，整个数据中心的能耗可以从其功率计来测量。可以使用外部工具（如安培表或瓦时表）或使用内置工具（例如与计量机架 PDU（配电单元）、ASIC（专用集成电路）等一起提供的工具）来测量单个服务器或硬盘驱动器。在电池供电系统中，电池中剩余的能量可以通过电池管理系统来确定，该系统是现代电池的一个组成部分。

- *静态分类*。有时实时数据收集是不可行的。例如，如果组织正在使用外部部署云，则可能无法直接访问实时能源数据。静态分类允许我们通过对使用的计算资源及其已知的能量特征（例如，存储设备每次获取使用的能量）进行编目来估计能耗。这些特性可来自基准（benchmarks）或制造商的规格。

- *动态分类*。在计算资源的静态模型不足的情况下，可能需要动态模型。与静态模型不同，动态模型根据对瞬态条件（如工作负载）的了解来估算能耗。该模型可以是简单的查表、基于先前执行期间收集的数据的回归模型或仿真。

### 资源分配

资源分配意味着分配资源以注意能源消耗的方式完成工作。资源分配的策略包括：减少使用、发现和调度。

- *减少使用*。可以通过特定于设备的活动（例如降低显示器的刷新率或使背景变暗）在设备级别减少使用量。当需求不再需要资源时，移除或停用资源是降低能耗的另一种方法。这可能涉及降低硬盘驱动器的转速、关闭 CPU 或服务器、以较慢的时钟速率运行 CPU，或关闭未使用的处理器块的电流。它还可能采取将虚拟机移动到最少数量的物理服务器上（整合）的形式，并关闭空闲的计算资源。在移动应用程序中，在通信的能耗低于计算的能耗的情况下，可以通过将部分计算工作放到云端来实现节能。

- *发现*。正如我们将在 [第7章][ch07] 中看到的，发现服务将服务请求方（来自客户端）与服务提供方进行匹配，支持这些服务的识别和远程调用。传统上，发现服务根据服务请求（通常是 API）的描述进行这些匹配。在考虑能效的背景下，该请求可以用能源信息进行注释，允许请求者根据其（可能是动态的）能源特征选择服务提供商（资源）。对于云，这些能源信息可以存储在“绿色服务目录”中，该目录由计量、静态分类或动态分类（资源监控策略）的信息填充。对于智能手机，可以从应用商店获得信息。目前，此类信息充其量是临时的，在服务 API 中通常不存在。

- *调度资源*。调度是将任务分配给计算资源。正如我们将在 [第9章][ch09] 中看到的，调度资源策略可以提高性能。在能源环境中，它可用于有效管理能源使用，给定任务限制并重视任务优先级。调度可以基于使用一种或多种资源监控策略收集的数据。使用云环境中的能源发现服务或多核上下文中的控制器，计算任务可以在计算资源（如服务提供商）之间动态切换，选择具有更高能效或更低能源成本的资源。例如，一个供应商可能比另一个供应商的负载更轻，允许它调整其能源使用，也许使用前面描述的一些策略，以实现平均每单位工作消耗更少的能源。

### 减少资源需求

这类策略在 [第9章][ch09] 中有详细说明。此类别中的策略 — 管理事件到达、限制事件响应、确定事件的优先级（可能让低优先级事件得不到服务）、减少计算开销、绑定执行时间以及提高资源使用效率 — 所有这些都通过减少工作量直接提高能源效率。这是减少用量的补充策略，因为减少用量策略假定需求保持不变，而减少资源需求策略是显式管理（和减少）需求的一种手段。

## 6.3 基于策略的能效问卷

如 [第3章][ch03] 所述，这份基于策略的调查问卷旨在非常快速地了解架构采用特定策略来管理能源效率的程度。

基于 [第6.2节][ch06sec02] 中描述的策略，我们可以创建一组受策略启发的问题，如 [表6.2][ch06tab02] 所示。为了大致了解为支持能源效率而做出的架构选择，分析师会询问每个问题并将答案记录在表中。然后，可以将这些问题的答案作为进一步活动的重点：文档调查、代码或其他工件分析、代码逆向工程等。

**表 6.2** 基于策略的能效问卷 <a name="ch06tab02"></a>

| 策略分组                                    | 策略问题                                | 支持与否（是/否） | 风险 | 设计决策与分布 | 基本原理和假设 |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :--------------- | :--- | :---------------------------- | :------------------------ |
| 资源监控                               | 你的系统是否**计量能源使用情况**？也就是说，系统是否通过传感器基础设施近乎实时地收集有关计算设备实际能耗的数据？ |                  |      |                               |                           |
| | 系统是否对设备和计算资源进行**静态分类**？也就是说，系统是否有参考值来估计设备或资源的能耗（在实时计量不可行或计算成本过高的情况下）？ |                                                              |                  |      |                               |
| 资源监控                               | 系统是否对设备和计算资源进行**动态分类**？如果静态分类由于负载或环境条件的变化而不准确，系统是否根据收集的先前数据使用动态模型来估计运行时设备或资源的不同能耗？ |                  |      |                               |                           |
| 资源分配                                 | 系统是否**减少使用量**以缩减资源使用量？也就是说，当需求不再需要资源时，系统是否可以停用资源以节省能源？这可能涉及降低硬盘驱动器的转速、使显示器变暗、关闭 CPU 或服务器、以较慢的时钟速率运行 CPU 或关闭未使用的处理器内存块。 |                  |      |                               |                           |
| | 系统是否**调度资源**以更有效地利用能源，通过切换计算资源来给定任务约束并尊重任务优先级，比如那些提供更好的能效性或者更低能源成本的服务提供商。是否基于收集的有关系统状态的数据（使用一种或多种资源监视策略）进行调度？ |                                                              |                  |      |                               |
| | 系统是否利用**发现服务**将服务请求与服务提供商进行匹配？在能源效率的背景下，服务请求可以用能源需求信息进行注释，允许请求者根据其（可能是动态的）能源特征选择服务提供商。 |                                                              |                  |      |                               |
| 减少资源需求                                | 你是否一直在尝试**减少资源需求**？在这里，你可以从 [第9章][ch09] 的基于策略的绩效问卷中插入此类别中的问题。 |                  |      |                               |                           |

## 6.4 模式

用于能源效率的模式的一些示例包括传感器融合、终止异常任务和电源监控。

### 传感器融合

移动应用程序和物联网系统通常使用多个传感器从其环境中收集数据。在此模式中，来自低功耗传感器的数据可用于推断是否需要从高功率传感器收集数据。移动电话上下文中的一个常见示例是使用加速度计数据来评估用户是否已移动，如果是，则更新 GPS 位置。此模式假设访问低功耗传感器在能耗方面比访问高功率传感器要小得多。

**好处：**

- 这种模式的明显好处是能够以智能方式最大限度地减少使用更耗能的设备，而不仅仅是减少查询高能耗传感器的频率。

**权衡：**

- 查询和比较多个传感器会增加前期的复杂性。

- 能耗更高的传感器将提供更高质量的数据，尽管代价是功耗增加。它将更快地提供这些数据，因为单独使用能源密集型传感器比先去查询辅助传感器花费的时间更少。

- 如果推断结果导致经常访问更高功率的传感器，则此模式可能会导致整体能耗更高。

### 终止异常任务

移动系统，因为它们经常执行未知来源的应用程序，最终可能会在不知不觉中运行一些异常耗电的应用程序。此模式提供了一种监视此类应用程序的能源使用情况以及中断或终止能源贪婪操作的方法。例如，如果应用发出声音警报并振动手机，而用户没有响应这些警报，则在预定的超时期限后，任务将被终止。

**好处：**

- 此模式提供了一个“故障安全”选项，用于管理具有未知能耗属性的应用的能耗。

**权衡：**

- 任何监视过程都会给系统操作增加少量开销，这可能会影响性能，并在小范围内影响能源使用。

- 需要考虑此模式的易用性。杀死高耗能的任务可能与用户的意图背道而驰。

### 电源监控

电源监控模式监视和管理系统设备，从而最大限度地减少它们处于活动状态的时间。此模式尝试自动禁用应用程序未主动使用的设备和接口。它长期以来一直用于集成电路中，当其中电路的块在不使用时会被关闭，以节省能源。

**好处：**

- 这种模式可以智能地节省功耗，而对最终用户几乎没有影响，前提是被关闭的设备确实不需要了。

**权衡：**

- 一旦设备关闭，与保持设备持续运行相比，打开它会增加一些延迟，然后才能响应。而且，在某些情况下，启动可能比一段时间的稳态运行更昂贵。

- 电源监控需要了解每个器件及其能耗特性，这增加了系统设计的前期复杂性。

## 6.5 扩展阅读

第一套公布的能源策略出现在[[Procaccianti 14][ref_213]]。这些部分是这里提出的战术的灵感来源。2014年的论文随后启发了[[Paradis 21][ref_203]]。本章中提出的许多策略都归功于这两篇论文。

有关软件开发中能源使用的良好一般介绍 - 以及开发人员不知道的内容 - 你应该阅读[[Pang 16][ref_202]]。

一些研究论文研究了设计选择对能源消耗的影响，例如[[Kazman 18][ref_143]]和[[Chowdhury 19][ref_59]]。

关于创建“能源感知”软件重要性的一般讨论可以在[[Fonseca 19][ref_90]]中找到。

移动设备的能量模式已由[[Cruz 19][ref_72]]和[[Schaarschmidt 20][ref_219]]编目。

## 6.6 问题讨论

1. 使用通用场景中的每个可能响应编写一组具体的能源效率场景。
   
2. 为智能手机应用（例如，运行状况监视应用）创建具体的能效场景。
   
3. 为数据中心中的数据服务器群集创建具体的能效场景。此场景与你为问题 2 创建的场景之间有什么重要区别？
   
4. 列举笔记本电脑或智能手机当前采用的能效技术。
   
5. 智能手机在使用Wi-Fi和蜂窝网络之间的能源权衡是什么？
   
6. 计算你在平均一生中将呼入大气的二氧化碳形式的温室气体量。这相当于多少次谷歌搜索？
   
7. 假设谷歌将每次搜索的能耗降低了1%。每年能节省多少能源？
   
8. 你用了多少能耗来回答问题7？

------

[ch06tab01]: ch06.md#ch06tab01
[ch06tab02]: ch06.md#ch06tab02
[ch06fig01]: ch06.md#ch06fig01
[ch06fig02]: ch06.md#ch06fig02
[ch06fig03]: ch06.md#ch06fig03

[ch06sec02]: ch06.md#ch06sec02

[ch03]: ch03.md#ch03
[ch07]: ch07.md#ch07
[ch09]: ch09.md#ch09

[ref_59]: ref01.md#ref_59
[ref_72]: ref01.md#ref_72
[ref_90]: ref01.md#ref_90
[ref_143]: ref01.md#ref_143
[ref_202]: ref01.md#ref_202
[ref_203]: ref01.md#ref_203
[ref_213]: ref01.md#ref_213
[ref_219]: ref01.md#ref_219